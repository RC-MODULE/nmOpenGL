# Утилиты

Здесь находятся специализированные функции написанные для решения некоторых задач nmOpenGL, зачастую с использованием векторных сопроцессоров. Эти функции самодостаточны и не используют контекст nmOpenGL.

## Состав

Функции подразделяются на три группы:
* `common` - здесь лежат функции, написанные на скалярном ядре и которые можно запускать на любом ядре
* `fixed` - здесь лежат функции, используещие векторный сопроцессор с целочисленной арифметикой
* `float` - здесь лежат функции, используещие векторный сопроцессор с плавающей точкой

## Тестирование

### Scons

-Для сборки тестов необходимо установить [Scons 4.0.1](https://www.scons.org/doc/production/HTML/scons-user.html#chap-build-install): `pip install scons==4.0.1`
-Можно собирать из `utilities`, `utilities/common`, `utilities/fixed`, `utilities/float` 
-Собрать цель: `scons target`
-Очистить сборку target: scons target -c


### Сборка
Основные сценарии сборки:
 - `scons` - собрать тесты
 - `scons emu` - собрать тесты для эмулятора
 - `scons run` - запустить тесты на плате mc12101
 - `scons emurun` - запустить тесты на эмуляторе

Для сборки отдельного теста test определены цели, совпадающие с названием папки с тестом
 - `scons test` - собрать test
 - `scons test-emu` - собрать тесты для эмулятора
 - `scons test-run` - запустить тесты на плате mc12101
 - `scons test-emurun` - запустить тесты на эмуляторе

Сборка и запуск отдельных тестов возможно только из папок fixed, float и common. 

> Важное замечание: scons кладет объектники рядом с исходниками.

TODO в папке `tests` сделать цели `float`, `fixed` и `common` 
TODO добавить запуск отдельных тестов из папки tests

В тестах есть несколько уровней логирования, которые задаются переменное debug_lvl в вызове scons, например `scons emu debug_lvl=2`
В зависимости от значения debug_lvl, есть следующие режимы:
- 0: Выводятся только ошибки
- 1: Выводятся сообщения первого уровня(по-умолчанию)
- 2: Выводятся сообщения второго и первого уровня
- 3: Выводятся сообщения третьего и ранних уровней
- 4: Выводятся сообщения четвертого и ранних уровней
- 5: Выводятся сообщения пятого и ранних уровней


### Отладка

Тесты и функции можно отлаживать с помощью nmc-gdb, но имеются некоторые ограничения:
- Отладка платы mc12101 недоступна
- Можно зайти внутрь только тех ассемблерных функций, что написаны на gas-ассмеблере (расширение .s)
- Запуск nmc-gdb следует делать из консоли `NMC-SDK`

Для отладки необходимо совершить следующие действия:
1. Запустить нужную цель с присваиванием переменной gdb единице, например `scons copyPacket_32s-emurun gdb=1`

```bash
$ cd utilities\fixed
$ scons copyPacket_32s-emurun gdb=1
...
nmc-qemu -g 10001 -fixed copyPacket_32s\qemu\main.abs

```

2. Запустить nmc-gdb в отдельной консоли, передав ему в качестве параметра файл .abs( nmc-gdb copyPacket_32s/qemu/main.abs )
Откроется окружение gdb
```
$ (gdb)
```
Чтобы подключиться к эмулятору необходимо запустить команду `target remote :port` (порт равен 10000 для ядра с плавающей точкой и 10001 для целочисленного ядра)
```
$ (gdb) target remote :10001
Remote debugging using :10001
0x2000000c in loadStackAddr ()
```

3. Затем можно поставить точку останова на main
```
$ (gdb) b main
Breakpoint 1 at 0x20000416: file fixed\copyPacket_32s\main.cpp, line 59.
```
4. И дойти до неё c помощью команды `c(continue)`
```bash
$ (gdb) c
Continuing.

Breakpoint 1, main () at fixed\copyPacket_32s\main.cpp:59
59              testValues();
```

5. Затем с помощью команд `s(step)`(шаг с заходом) и `n(next)`(шаг без захода) можно идти по шагам. 

```bash
$ (gdb) s
testValues () at fixed\copyPacket_32s\main.cpp:39
39              src[0] = 0;

```

Чтобы поставить точку останова на нужную строку, необходимо вызвать breakpoint в следующем формате: `b(breakpoint) file:line`, например:
```bash
$ (gdb) b main.cpp:39
Breakpoint 2 at 0x200002c8: file fixed\copyPacket_32s\main.cpp, line 39.
```
Для просмотра кода есть команда list(l)
```bash
$ (gdb) l
34              }
35              DEBUG_PLOG_LEVEL_0("Test size OK\n");
36      }
37
38      void testValues(){
39              src[0] = 0;
40              src[1] = -3;
41              src[2] = 4;
42              src[3] = -1;
43              int ref_values[4] = {0, -3, 4, -1};
```

Для выхода из отладки необходимо ввести quit и подтвердить. Программа при этом завершится тоже
```bash
$ (gdb) quit
A debugging session is active.

        Inferior 1 [Remote target] will be killed.

Quit anyway? (y or n) y

```


